<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bakenovation | Studio Console</title>
    <link rel="stylesheet" href="admin_premium.css">
</head>

<body>
    <div class="container">
        <header>
            <p class="subtitle">Bespoke Excellence</p>
            <h1>Artisan Console</h1>
        </header>

        <div class="controls">
            <button class="btn" onclick="loadOrders()">
                <span>üîÑ</span> Refresh Orders
            </button>
            <button class="btn" onclick="runDiagnostic()">
                <span>üîç</span> System Health
            </button>
        </div>

        <div id="orders-container" class="grid">
            <div class="loading-state">Initialising encrypted link...</div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxc2EYUsCqjcHKLuvLlG5QCnKx5iKVvcIEaWwUDjrSvnmf1maKzr8rH6Cc7YCUckDHs/exec';

        async function loadOrders() {
            const container = document.getElementById('orders-container');
            container.innerHTML = '<div class="loading-state">Syncing Orders...</div>';

            try {
                const res = await fetch(`${GAS_URL}?action=list`);
                const data = await res.json();

                if (data.status === 'success') {
                    render(data.orders);
                } else {
                    container.innerHTML = `<div class="loading-state" style="color:#ff4d4d">Server Sync Failed: ${data.message}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="loading-state" style="color:#ff4d4d">Network Fault: ${e.message}</div>`;
            }
        }

        function render(orders) {
            const container = document.getElementById('orders-container');
            if (!orders || orders.length === 0) {
                container.innerHTML = '<div class="loading-state">No orders in current cycle.</div>';
                return;
            }

            container.innerHTML = orders.reverse().map((o, idx) => {
                let details = {};
                try {
                    details = typeof o.OrderDetails === 'string' ? JSON.parse(o.OrderDetails) : (o.OrderDetails || {});
                } catch (e) { console.warn('Parse fail:', o.OrderID); }

                const statusClass = `badge-${(o.Status || 'pending').toLowerCase()}`;
                const isPending = (o.Status || '').toLowerCase() === 'pending';
                const isQuoted = (o.Status || '').toLowerCase() === 'quoted';

                return `
                    <div class="card" style="animation-delay: ${idx * 0.1}s">
                        <div class="card-header">
                            <span class="order-id">${o.OrderID || 'N/A'}</span>
                            <span class="badge ${statusClass}">${o.Status || 'Pending'}</span>
                        </div>
                        
                        <div class="customer-info">
                            <h3>${o.Name || 'Anonymous Client'}</h3>
                            <p>üìû ${o.Phone || 'No Contact'}</p>
                        </div>

                        <div class="details-panel">
                            <div><strong>Flavor:</strong> ${details.flavor || 'N/A'}</div>
                            <div><strong>Structure:</strong> ${details.tiers || 'N/A'} Tiers</div>
                            ${details.message ? `<div><strong>Dedication:</strong> "${details.message}"</div>` : ''}
                            ${o.DeliveryDate ? `<div><strong>Schedule:</strong> ${o.DeliveryDate}</div>` : ''}
                            ${o.Amount ? `<div><strong>Investment:</strong> ‚Çπ${o.Amount}</div>` : ''}
                        </div>

                        <div class="action-panel">
                            ${isPending ? `
                                <div class="action-form">
                                    <div class="input-row">
                                        <input type="number" id="amt-${o.OrderID}" placeholder="Amount (‚Çπ)">
                                        <input type="date" id="date-${o.OrderID}">
                                    </div>
                                    <button class="btn" onclick="sendQuote(event, '${o.OrderID}')">Confirm & Send Quote</button>
                                </div>
                            ` : isQuoted ? `
                                <button class="btn" onclick="updateStatus(event, '${o.OrderID}', 'Paid')">Confirm Receipt of Payment</button>
                            ` : '<p style="text-align:center; opacity:0.5; font-size:0.8rem">Archive Entry Only</p>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- UNIVERSAL NO-CORS SENDER ---
        async function sendToScript(payload) {
            // "no-cors" mode means we can't read the response, but the browser allows the send.
            // We blindly assume success if no network error occurs.
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        async function sendQuote(event, id) {
            const btn = event.currentTarget;
            const amount = document.getElementById(`amt-${id}`).value;
            const date = document.getElementById(`date-${id}`).value;

            if (!amount || !date) {
                alert('‚ö†Ô∏è Please enter both Amount and Date.');
                return;
            }

            // Resilient lookup data
            const card = btn.closest('.card');
            const name = card.querySelector('h3').innerText;
            const phone = card.querySelector('p').innerText.replace('üìû ', '');

            const originalText = btn.innerHTML;
            btn.innerHTML = 'üöÄ Sending...';
            btn.disabled = true;

            try {
                await sendToScript({
                    action: 'update_order',
                    orderId: id,
                    amount: amount,
                    deliveryDate: date,
                    status: 'Quoted',
                    name: name,
                    phone: phone
                });

                // Optimistic Success Message
                alert('‚úÖ Request Sent!\n\nThe dashboard will refresh in a few seconds.');

                // Add a small delay then reload to hopefully show the new state
                setTimeout(() => loadOrders(), 2000);

            } catch (e) {
                alert('‚ùå Network Error: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function updateStatus(event, id, status) {
            const btn = event.currentTarget;
            const card = btn.closest('.card');
            const name = card.querySelector('h3').innerText;
            const phone = card.querySelector('p').innerText.replace('üìû ', '');

            const originalText = btn.innerHTML;
            btn.innerHTML = 'üöÄ Updating...';
            btn.disabled = true;

            try {
                await sendToScript({
                    action: 'update_order',
                    orderId: id,
                    status: status,
                    name: name,
                    phone: phone
                });

                alert('‚úÖ Status Updated!\n\nRefreshing...');
                setTimeout(() => loadOrders(), 2000);

            } catch (e) {
                alert('‚ùå Network Error: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function runDiagnostic() {
            try {
                const res = await fetch(`${GAS_URL}?action=diagnostic`);
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`CONSOLE HEALTH REPORT\n\n- Spreadsheet: ${data.spreadsheetName}\n- Tabs: ${data.tabsFound.join(', ')}\n- Active Trace: ${data.activeTabUsed}\n- Headers: ${data.headers.join(' | ')}`);
                } else alert('Health Check Failed: ' + data.message);
            } catch (e) { alert('Critical Fault: ' + e.message); }
        }

        loadOrders();
    </script>
</body>

</html>