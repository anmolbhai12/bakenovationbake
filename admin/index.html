<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bakenovation | Studio Console</title>
    <link rel="stylesheet" href="admin_premium.css">
</head>

<body>
    <div class="container">
        <header>
            <p class="subtitle"
                style="color: var(--color-gold); letter-spacing: 0.15em; text-transform: uppercase; font-size: 0.7rem; margin-bottom: 5px;">
                Bakenovation Royale</p>
            <h1
                style="color: var(--color-gold); font-family: var(--font-heading); letter-spacing: 0.1em; text-shadow: 0 4px 10px rgba(0,0,0,0.4);">
                Artisan Console</h1>
        </header>

        <div class="controls">
            <button class="btn" onclick="loadOrders()">
                <span>üîÑ</span> Refresh Orders
            </button>
            <button class="btn" onclick="runDiagnostic()">
                <span>üîç</span> System Health
            </button>
        </div>

        <div id="orders-container" class="grid">
            <div class="loading-state">Initialising encrypted link...</div>
        </div>
    </div>

    <script>
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxc2EYUsCqjcHKLuvLlG5QCnKx5iKVvcIEaWwUDjrSvnmf1maKzr8rH6Cc7YCUckDHs/exec';

        async function loadOrders() {
            const container = document.getElementById('orders-container');
            container.innerHTML = '<div class="loading-state">Syncing Orders...</div>';

            try {
                const res = await fetch(`${GAS_URL}?action=list_orders`);
                const data = await res.json();

                if (data.status === 'success') {
                    render(data.orders);
                } else {
                    container.innerHTML = `<div class="loading-state" style="color:#ff4d4d">Server Sync Failed: ${data.message}</div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="loading-state" style="color:#ff4d4d">Network Fault: ${e.message}</div>`;
            }
        }

        function render(orders) {
            const container = document.getElementById('orders-container');
            if (!orders || orders.length === 0) {
                container.innerHTML = '<div class="loading-state">No orders in current cycle.</div>';
                return;
            }

            container.innerHTML = orders.reverse().map((o, idx) => {
                let details = {};
                try {
                    details = typeof o.OrderDetails === 'string' ? JSON.parse(o.OrderDetails) : (o.OrderDetails || {});
                } catch (e) { console.warn('Parse fail:', o.OrderID); }

                const statusClass = `badge-${(o.Status || 'pending').toLowerCase()}`;
                const isPending = (o.Status || '').toLowerCase() === 'pending';
                const isQuoted = (o.Status || '').toLowerCase() === 'quoted';

                return `
                    <div class="card" style="animation-delay: ${idx * 0.1}s">
                        <div class="card-header">
                            <span class="order-id">${o.OrderID || 'N/A'}</span>
                            <span class="badge ${statusClass}">${o.Status || 'Pending'}</span>
                        </div>
                        
                        <div class="customer-info">
                            <h3>${o.Name || 'Anonymous Client'}</h3>
                            <p>üìû ${o.Phone || 'No Contact'}</p>
                        </div>

                        <div class="details-panel">
                            <div><strong>Flavor:</strong> ${details.flavor || 'N/A'}</div>
                            <div><strong>Structure:</strong> ${details.tiers || 'N/A'} Tiers</div>
                            ${details.message ? `<div><strong>Dedication:</strong> "${details.message}"</div>` : ''}
                            ${o.DeliveryDate ? `<div><strong>Date:</strong> ${o.DeliveryDate}</div>` : ''}
                            ${o.DeliveryTime ? `<div><strong>Time:</strong> ${o.DeliveryTime}</div>` : ''}
                            ${o.Amount ? `<div><strong>Total:</strong> ‚Çπ${o.Amount}</div>` : ''}
                        </div>

                        <div class="action-panel">
                            ${isPending ? `
                                <div class="action-form">
                                    <div class="input-row">
                                        <input type="number" id="amt-${o.OrderID}" placeholder="Amount (‚Çπ)">
                                        <input type="date" id="date-${o.OrderID}">
                                        <input type="time" id="time-${o.OrderID}">
                                    </div>
                                    <button class="btn" onclick="sendToNegotiator(event, '${o.OrderID}')">Start WhatsApp Negotiation</button>
                                </div>
                            ` : isQuoted ? `
                                <div style="display:grid; gap:10px">
                                    <span style="color:#d4af37; font-size:0.8rem">Waiting for customer confirmation...</span>
                                    <button class="btn" onclick="updateStatus(event, '${o.OrderID}', 'Paid')">Confirm Receipt of Payment</button>
                                </div>
                            ` : o.Status === 'Negotiating' ? `
                                <div style="display:grid; gap:10px">
                                    <span style="color:#00e676; font-size:0.8rem">Bot is interacting with client...</span>
                                    <button class="btn" onclick="loadOrders()">Refresh Status</button>
                                </div>
                            ` : '<p style="text-align:center; opacity:0.5; font-size:0.8rem">Order Finalised</p>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- UNIVERSAL NO-CORS SENDER ---
        async function sendToScript(payload) {
            // "no-cors" mode means we can't read the response, but the browser allows the send.
            // We blindly assume success if no network error occurs.
            await fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        async function sendToNegotiator(event, id) {
            const btn = event.currentTarget;
            const amount = document.getElementById(`amt-${id}`).value;
            const date = document.getElementById(`date-${id}`).value;
            const time = document.getElementById(`time-${id}`).value;

            if (!amount || !date || !time) {
                alert('‚ö†Ô∏è Please enter Amount, Date, and Time.');
                return;
            }

            const card = btn.closest('.card');
            const phone = card.querySelector('p').innerText.replace('üìû ', '');

            const originalText = btn.innerHTML;
            btn.innerHTML = 'üöÄ Handing to Bot...';
            btn.disabled = true;

            try {
                // 1. Update Sheet with Quote Data & move to "Negotiating"
                await sendToScript({
                    action: 'update_order',
                    orderId: id,
                    amount: amount,
                    deliveryDate: date,
                    deliveryTime: time,
                    status: 'Negotiating',
                    botState: 'AWAITING_CONFIRMATION'
                });

                // 2. Trigger Bot to send the details for verification
                // We call our server.js endpoint which then talks to the client
                const botRes = await fetch('https://bakenovation-bot.alwaysdata.net/send-negotiation-start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: phone,
                        orderId: id,
                        amount: amount,
                        date: date,
                        time: time
                    })
                });

                alert('‚úÖ Verification Request Sent!\n\nThe bot will now confirm details with the client.');
                setTimeout(() => loadOrders(), 2000);

            } catch (e) {
                alert('‚ùå Fault: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function updateStatus(event, id, status) {
            const btn = event.currentTarget;
            const card = btn.closest('.card');
            const name = card.querySelector('h3').innerText;
            const phone = card.querySelector('p').innerText.replace('üìû ', '');

            const originalText = btn.innerHTML;
            btn.innerHTML = 'üöÄ Updating...';
            btn.disabled = true;

            try {
                await sendToScript({
                    action: 'update_order',
                    orderId: id,
                    status: status,
                    name: name,
                    phone: phone
                });

                alert('‚úÖ Status Updated!\n\nRefreshing...');
                setTimeout(() => loadOrders(), 2000);

            } catch (e) {
                alert('‚ùå Network Error: ' + e.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function runDiagnostic() {
            try {
                const res = await fetch(`${GAS_URL}?action=diagnostic`);
                const data = await res.json();
                if (data.status === 'success') {
                    alert(`CONSOLE HEALTH REPORT\n\n- Spreadsheet: ${data.spreadsheetName}\n- Tabs: ${data.tabsFound.join(', ')}\n- Active Trace: ${data.activeTabUsed}\n- Headers: ${data.headers.join(' | ')}`);
                } else alert('Health Check Failed: ' + data.message);
            } catch (e) { alert('Critical Fault: ' + e.message); }
        }

        loadOrders();
    </script>
</body>

</html>